flowchart TB
    %% Geth Execution Client Main Program Graph
    %% Nodes: 29, Edges: 32
    
    %% Style definitions
    classDef stateNode fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef actionNode fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef errorNode fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef clNode fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    
    %% Subgraph: Consensus Layer
    subgraph CL["Consensus Layer (TRUSTED)"]
        STATE-CL-PREPARING-FORKCHOICE["CL Preparing<br/>ForkchoiceUpdated"]
        STATE-CL-PREPARING-NEWPAYLOAD["CL Preparing<br/>NewPayload"]
    end
    
    %% Subgraph: Execution Layer
    subgraph EL["Execution Layer - Geth (TRUSTED)"]
        STATE-EL-IDLE["EL Idle"]
        ACTION-EL-VALIDATE-JWT["Validate JWT"]
        STATE-EL-JWT-REJECTED["JWT Rejected"]
        
        subgraph FCU["ForkchoiceUpdated Flow"]
            ACTION-EL-PROCESS-FORKCHOICE["Process<br/>ForkchoiceUpdated"]
            ACTION-EL-CHECK-BLOCK-EXISTS["Check Block<br/>Exists"]
            STATE-EL-SYNCING["Syncing"]
            ACTION-EL-SET-CANONICAL-HEAD["Set Canonical<br/>Head"]
            ACTION-EL-UPDATE-FINALIZED-SAFE["Update<br/>Finalized/Safe"]
            ACTION-EL-START-PAYLOAD-BUILD["Start Payload<br/>Build"]
            STATE-EL-PAYLOAD-BUILDING["Payload<br/>Building"]
            STATE-EL-FORKCHOICE-RESPONSE-READY["Response<br/>Ready"]
        end
        
        subgraph NP["NewPayload Flow"]
            ACTION-EL-PROCESS-NEWPAYLOAD["Process<br/>NewPayload"]
            ACTION-EL-VALIDATE-PAYLOAD-STRUCTURE["Validate<br/>Structure"]
            STATE-EL-PAYLOAD-INVALID-STRUCTURE["Invalid<br/>Structure"]
            ACTION-EL-CONVERT-PAYLOAD-TO-BLOCK["Convert to<br/>Block"]
            ACTION-EL-INSERT-BLOCK-WITHOUT-HEAD["Insert Block"]
            ACTION-EL-PROCESS-BLOCK["Process<br/>Transactions"]
            STATE-EL-BLOCK-VALID["Block Valid"]
            STATE-EL-BLOCK-INVALID["Block Invalid"]
            ACTION-EL-COMMIT-STATE["Commit State"]
            STATE-EL-NEWPAYLOAD-RESPONSE-READY["Response<br/>Ready"]
        end
    end
    
    %% Edges
    STATE-CL-PREPARING-FORKCHOICE -->|"engine_forkchoiceUpdated"| ACTION-EL-VALIDATE-JWT
    STATE-CL-PREPARING-NEWPAYLOAD -->|"engine_newPayload"| ACTION-EL-VALIDATE-JWT
    ACTION-EL-VALIDATE-JWT -->|"valid"| ACTION-EL-PROCESS-FORKCHOICE
    ACTION-EL-VALIDATE-JWT -->|"valid"| ACTION-EL-PROCESS-NEWPAYLOAD
    ACTION-EL-VALIDATE-JWT -->|"invalid"| STATE-EL-JWT-REJECTED
    ACTION-EL-PROCESS-FORKCHOICE --> ACTION-EL-CHECK-BLOCK-EXISTS
    ACTION-EL-CHECK-BLOCK-EXISTS -->|"not found"| STATE-EL-SYNCING
    ACTION-EL-CHECK-BLOCK-EXISTS -->|"exists"| ACTION-EL-SET-CANONICAL-HEAD
    ACTION-EL-SET-CANONICAL-HEAD --> ACTION-EL-UPDATE-FINALIZED-SAFE
    ACTION-EL-UPDATE-FINALIZED-SAFE -->|"with attrs"| ACTION-EL-START-PAYLOAD-BUILD
    ACTION-EL-UPDATE-FINALIZED-SAFE -->|"no attrs"| STATE-EL-FORKCHOICE-RESPONSE-READY
    ACTION-EL-START-PAYLOAD-BUILD --> STATE-EL-PAYLOAD-BUILDING
    ACTION-EL-START-PAYLOAD-BUILD --> STATE-EL-FORKCHOICE-RESPONSE-READY
    STATE-EL-FORKCHOICE-RESPONSE-READY --> STATE-EL-IDLE
    ACTION-EL-PROCESS-NEWPAYLOAD --> ACTION-EL-VALIDATE-PAYLOAD-STRUCTURE
    ACTION-EL-VALIDATE-PAYLOAD-STRUCTURE -->|"invalid"| STATE-EL-PAYLOAD-INVALID-STRUCTURE
    ACTION-EL-VALIDATE-PAYLOAD-STRUCTURE -->|"valid"| ACTION-EL-CONVERT-PAYLOAD-TO-BLOCK
    ACTION-EL-CONVERT-PAYLOAD-TO-BLOCK --> ACTION-EL-INSERT-BLOCK-WITHOUT-HEAD
    ACTION-EL-INSERT-BLOCK-WITHOUT-HEAD --> ACTION-EL-PROCESS-BLOCK
    ACTION-EL-PROCESS-BLOCK -->|"success"| STATE-EL-BLOCK-VALID
    ACTION-EL-PROCESS-BLOCK -->|"failure"| STATE-EL-BLOCK-INVALID
    STATE-EL-BLOCK-VALID --> ACTION-EL-COMMIT-STATE
    ACTION-EL-COMMIT-STATE --> STATE-EL-NEWPAYLOAD-RESPONSE-READY
    STATE-EL-NEWPAYLOAD-RESPONSE-READY --> STATE-EL-IDLE
    
    %% Apply styles
    class STATE-CL-PREPARING-FORKCHOICE,STATE-CL-PREPARING-NEWPAYLOAD clNode
    class STATE-EL-IDLE,STATE-EL-SYNCING,STATE-EL-PAYLOAD-BUILDING,STATE-EL-FORKCHOICE-RESPONSE-READY,STATE-EL-BLOCK-VALID,STATE-EL-NEWPAYLOAD-RESPONSE-READY stateNode
    class ACTION-EL-VALIDATE-JWT,ACTION-EL-PROCESS-FORKCHOICE,ACTION-EL-CHECK-BLOCK-EXISTS,ACTION-EL-SET-CANONICAL-HEAD,ACTION-EL-UPDATE-FINALIZED-SAFE,ACTION-EL-START-PAYLOAD-BUILD,ACTION-EL-PROCESS-NEWPAYLOAD,ACTION-EL-VALIDATE-PAYLOAD-STRUCTURE,ACTION-EL-CONVERT-PAYLOAD-TO-BLOCK,ACTION-EL-INSERT-BLOCK-WITHOUT-HEAD,ACTION-EL-PROCESS-BLOCK,ACTION-EL-COMMIT-STATE actionNode
    class STATE-EL-JWT-REJECTED,STATE-EL-PAYLOAD-INVALID-STRUCTURE,STATE-EL-BLOCK-INVALID errorNode
